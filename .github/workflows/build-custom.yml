name: Flutter Build Android & Windows (Stable 3.41)

env:
  FLUTTER_VERSION: '3.41.2'

on:
  workflow_dispatch:
    inputs:
      build_android:
        description: 'Build Android'
        required: false
        default: true
        type: boolean

      build_windows:
        description: 'Build Windows'
        required: false
        default: true
        type: boolean

      publish_release:
        description: 'Publish to GitHub Release'
        required: false
        default: false
        type: boolean

      release_tag:
        description: 'Release Tag (e.g., v1.0.0)'
        required: false
        default: ''
        type: string

      prerelease:
        description: 'Is this a Pre-release?'
        required: false
        default: false
        type: boolean

jobs:
  # ==========================================
  # ANDROID BUILD
  # ==========================================
  android:
    if: ${{ github.event.inputs.build_android == 'true' }}
    name: Build Android
    runs-on: ubuntu-latest
    permissions: write-all

    steps:
      - name: üì¶ Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ‚òï Setup Java Environment
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'
          cache: 'gradle'

      - name: üê¶ Install Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: stable
          cache: true

      - name: üìù Inject Fallback Keys
        shell: bash
        run: |
          mkdir -p lib/secrets
          cat > lib/secrets/fallback.dart <<'EOF'
          const String siliconflowFallbackKey = '${{ secrets.SILICONFLOW_KEY }}';
          EOF

      - name: üìù Extract Version Number
        id: version
        run: |
          VERSION=$(grep 'version:' pubspec.yaml | sed 's/version: //' | tr -d ' ')
          if [ "${{ github.event.inputs.publish_release }}" != "true" ]; then
            SHORT_SHA=$(git rev-parse --short HEAD)
            VERSION="${VERSION}_${SHORT_SHA}"
          fi
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "Version: $VERSION"

      - name: üîë Configure Android Signing
        if: ${{ env.SIGN_KEYSTORE_BASE64 != '' }}
        env:
          SIGN_KEYSTORE_BASE64: ${{ secrets.SIGN_KEYSTORE_BASE64 }}
        run: |
          echo "$SIGN_KEYSTORE_BASE64" | base64 --decode > android/app/key.jks
          echo "storeFile=key.jks" >> android/key.properties
          echo "storePassword=${{ secrets.KEYSTORE_PASSWORD }}" >> android/key.properties
          echo "keyAlias=${{ secrets.KEY_ALIAS }}" >> android/key.properties
          echo "keyPassword=${{ secrets.KEY_PASSWORD }}" >> android/key.properties
          echo "‚úÖ Keystore configuration complete"

      - name: üèóÔ∏è Build APK
        run: flutter build apk --release --split-per-abi

      - name: üì¶ Rename APKs
        run: |
          cd build/app/outputs/flutter-apk
          for file in app-*-release.apk; do
            abi=$(echo "$file" | sed -E 's/app-(.*)-release\.apk/\1/')
            mv "$file" "Kelivo_android_${VERSION}_${abi}.apk"
          done

      - name: üöÄ Publish to GitHub Release
        if: ${{ github.event.inputs.publish_release == 'true' && github.event.inputs.release_tag != '' }}
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event.inputs.release_tag }}
          name: ${{ github.event.inputs.release_tag }}
          prerelease: ${{ github.event.inputs.prerelease }}
          files: build/app/outputs/flutter-apk/Kelivo_android_*.apk

      - name: üì§ Upload Artifact (arm64-v8a)
        uses: actions/upload-artifact@v4
        with:
          name: Android-arm64-v8a
          path: build/app/outputs/flutter-apk/Kelivo_android_*_arm64-v8a.apk

      - name: üì§ Upload Artifact (armeabi-v7a)
        uses: actions/upload-artifact@v4
        with:
          name: Android-armeabi-v7a
          path: build/app/outputs/flutter-apk/Kelivo_android_*_armeabi-v7a.apk

      - name: üì§ Upload Artifact (x86_64)
        uses: actions/upload-artifact@v4
        with:
          name: Android-x86_64
          path: build/app/outputs/flutter-apk/Kelivo_android_*_x86_64.apk

  # ==========================================
  # WINDOWS BUILD
  # ==========================================
  windows:
    if: ${{ github.event.inputs.build_windows == 'true' }}
    name: Build Windows
    runs-on: windows-latest
    permissions: write-all

    steps:
      - name: üì¶ Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: üîß Install Latest CMake
        uses: lukka/get-cmake@latest

      - name: üê¶ Install Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: stable
          cache: true

      - name: üìù Inject Fallback Keys
        shell: bash
        run: |
          mkdir -p lib/secrets
          cat > lib/secrets/fallback.dart <<'EOF'
          const String siliconflowFallbackKey = '${{ secrets.SILICONFLOW_KEY }}';
          EOF

      - name: üîß Get Flutter Dependencies
        run: flutter pub get

      - name: üîç Verify CMake Version
        shell: pwsh
        run: |
          Write-Host "Checking CMake version..."
          cmake --version
          $cmakeVersion = (cmake --version | Select-String "cmake version" | ForEach-Object { $_.ToString() })
          Write-Host "Current CMake: $cmakeVersion"

      - name: üìù Extract Version Number
        shell: pwsh
        run: |
          $version = (Select-String -Path pubspec.yaml -Pattern "version:" | ForEach-Object { $_.Line.Split(":")[1].Trim() })
          if ("${{ github.event.inputs.publish_release }}" -ne "true") {
            $shortSha = git rev-parse --short HEAD
            $version = "$version`_$shortSha"
          }
          echo "VERSION=$version" >> $env:GITHUB_ENV
          Write-Host "Version: $version"

      - name: üèóÔ∏è Build Windows App
        run: flutter build windows --release

      - name: üì¶ Create ZIP Archive
        shell: pwsh
        run: |
          Compress-Archive -Path "build/windows/x64/runner/Release/*" -DestinationPath "Kelivo_windows_$env:VERSION.zip"

      - name: üîß Install Inno Setup
        run: choco install innosetup -y

      - name: üì¶ Create Windows Installer (.exe)
        shell: pwsh
        run: |
          # Generate Inno Setup Script
          $issContent = @"
          #define MyAppName "Kelivo"
          #define MyAppVersion "$env:VERSION"
          #define MyAppPublisher "Psyche"
          #define MyAppExeName "kelivo.exe"
          [Setup]
          AppId={{A7B8C9D0-E1F2-4A5B-8C9D-0E1F2A3B4C5D}}
          AppName={#MyAppName}
          AppVersion={#MyAppVersion}
          AppPublisher={#MyAppPublisher}
          DefaultDirName={autopf}\{#MyAppName}
          DefaultGroupName={#MyAppName}
          OutputDir=.
          OutputBaseFilename=Kelivo_windows_{#MyAppVersion}_setup
          Compression=lzma2
          SolidCompression=yes
          WizardStyle=modern
          ArchitecturesInstallIn64BitMode=x64
          ArchitecturesAllowed=x64
          UninstallDisplayIcon={app}\{#MyAppExeName}
          
          [Languages]
          Name: "english"; MessagesFile: "compiler:Default.isl"
          
          [Tasks]
          Name: "desktopicon"; Description: "Create a desktop shortcut"; GroupDescription: "Additional icons:"
          
          [Files]
          Source: "build\windows\x64\runner\Release\*"; DestDir: "{app}"; Flags: ignoreversion recursesubdirs createallsubdirs
          
          [Icons]
          Name: "{group}\{#MyAppName}"; Filename: "{app}\{#MyAppExeName}"
          Name: "{group}\Uninstall {#MyAppName}"; Filename: "{uninstallexe}"
          Name: "{autodesktop}\{#MyAppName}"; Filename: "{app}\{#MyAppExeName}"; Tasks: desktopicon
          
          [Run]
          Filename: "{app}\{#MyAppExeName}"; Description: "Launch {#MyAppName}"; Flags: nowait postinstall skipifsilent
          "@
          
          # Save with UTF-8 encoding
          $issContent | Out-File -FilePath "installer.iss" -Encoding utf8BOM
          
          # Compile the installer
          & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" "installer.iss"

      - name: üöÄ Publish to GitHub Release
        if: ${{ github.event.inputs.publish_release == 'true' && github.event.inputs.release_tag != '' }}
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event.inputs.release_tag }}
          name: ${{ github.event.inputs.release_tag }}
          prerelease: ${{ github.event.inputs.prerelease }}
          files: |
            Kelivo_windows_*.zip
            Kelivo_windows_*_setup.exe

      - name: üì§ Upload Artifact (ZIP)
        uses: actions/upload-artifact@v4
        with:
          name: Windows-ZIP
          path: Kelivo_windows_*.zip

      - name: üì§ Upload Artifact (Installer)
        uses: actions/upload-artifact@v4
        with:
          name: Windows-Installer
          path: Kelivo_windows_*_setup.exe